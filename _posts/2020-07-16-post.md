---
title:  "메모리 누수에 관하여"
excerpt: "메모리 떡상 가즈아ㅏㅏㅏㅏㅏㅏ"

permalink: /posts/20200716/1
---


개발한 프로그램 중에 온프라미스 형식으로 설치한 프로그램에 대하여 sr이 왔다.

그 당시 대시보드의 스크린샷과 함께.. 메모리가 7기가까지 튀었다는 내용이었다;;;

사실 메모리에 대한 로그도 따로 쌓지 않았고, 힙덤프도 주지 않고 덜렁 솟았다는 내용만 받았기에 이유는 알 수 없었다.

설치형보다 더 오래 운영한 전사서버에서는 발생하지 않았던 현상인데.. 여튼 그리하여 메모리 누수에 대해 알아보고 정리하는 시간을 갖게 되었다.

- GC?

일반적으로 많은 경우에서 gc가 알아서 갈 곳을 잃은 메모리들에 대해 정리를 해줘서 신경을 쓰지 않아도 된다. 근데..

- 메모리 누수가 발생하는 원인

1. static 변수의 레퍼런스 참조 (캐쉬 등)

2. 닫지 않은 stream, connection

3. 참조가 계속 되어 gc 대상에 걸리지 않는 경우 (익명 클래스, classloader 등)

이외에도 있나봄??

이거에 대해서 재밌는 질문을 찾았다.

[억덕계 해야 메모리 누수를 발생시킬 수 있나요?](https://stackoverflow.com/questions/6470651/how-to-create-a-memory-leak-in-java){: target="_blank"} 라는 질문이다.

메모리 누수에 대해 오만가지 얘기들이 있으니 한번 보자 ㄱㄱ

근데 보면.. 위에 대한게 실질적으로는 "언젠간" GC에 의해 정리가 되는 친구라고 한다. 

영원한 메모리 누수가 아닌 단기 시간 내에서 해결하지 못해 치솟는 메모리 릭이라는 거다. (이게 얼마나인지는 모르겠다. 실제 사례를 보면 단 2일 사이에 1.5기가에서 7기가까지 치솟았다)

그럴듯한 얘긴 듯? 그게 아니라면 운영 중인건 옛날에 터졌어야 할거 같은데;;

-----------------------------------------------

그래서 뭐가 문제였을까.. 소스코드를 찬찬히 뜯어보았다.

잘 살펴보니....... 공통 class 중에서 ShellExecutor라는 친구가 있었는데 이 친구가 shell 관련해서 stdout, stderr 관련해서 stream을 열고 닫질 않고 있었네;;;;

아 이건 무적권이지 엌ㅋ

네.. 그래서 해결

그리고....... 내부에서 thread를 익명클래스로 만들어서 사용하는 부분이 있었음.. outer class를 참조하게 되어있고 또한 유저가 취소하기 전까진 무한대로 도는 친구라서(이거는 의도한 로직이지만) 쓰레드 최대갯수가 정해져 있긴 하지만 이 또한 누수에 영향을 줬을거라고 생각한다.

이렇게 두 부분을 해결을 봤다. 

그리고 내부 시스템에서 asis와 tobe를 동시에 띄우고 냅뒀다. (개발계)

긴 시간은 아니지만 그대로 사용하게 하고 3일 후에 확인해본 결과 tobe가 asis보다 확실히 메모리 점유율이 낮아졌음을 확인할 수 있었다.

나는 cluster 환경에서 확인해서 "kubectl top pod" 으로 확인했지만

좀더 정확히 확인하기 위해서는 프로그램 상에 소스코드를 추가하거나 메모리 분석도구를 사용하면 된다고 한다.

아 그냥 로그 찍을게여

- java 메모리 관련 메소드

Runtime.getRuntime().maxMemory() - 프로그램에 할당된 전체 메모리

Runtime.getRuntime().totalMemory() - 현재 할당된 메모리

Runtime.getRuntime().freeMemory() - 현재 할당된 메모리 중 사용가능한 메모리

음 그러니까 현재 사용중인 메모리는 total - free가 되고

프로그램이 앞으로 사용할 수 있는 모든 메모리는 max에서 위를 빼서  max - (total - free) 가 된다는 뜻임

---------------------

아니 근데 찾다보니 [메모리 누수 원인에 대해 이쁘게 정리한 곳](https://www.baeldung.com/java-memory-leaks){: target="_blank"}이 있네

아무튼 일단 대충 위와 같이 처리를 했다. 왜냐면 난 8월 초까지 굉장히 바쁘기 때문이다.....

일이 너무 많은데 힙덤프 요청해서 분석할 시간이 없어서 일단 홀딩시켜놨다.

8월 이후에도 아마 메모리 릭 현상이 계속 된다면 힙덤프를 요청하여 제대로 분석을 해봐야 할 것 같다.